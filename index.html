<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>دليل الشهادات المهنية - جامعة الأميرة نورة</title>
    <!-- الخطوط -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    <!-- مكتبة قراءة ملفات الإكسل (SheetJS) -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    
    <style>
        :root {
            /* لوحة الألوان الجديدة المتدرجة */
            --color-1: #027680; /* بترولي غامق */
            --color-2: #49baaa; /* تيفاني متوسط */
            --color-3: #42b677; /* أخضر فاتح */
            
            --gradient-main: linear-gradient(135deg, var(--color-1) 0%, var(--color-2) 100%);
            --gradient-accent: linear-gradient(45deg, var(--color-2), var(--color-3));
            
            --text-dark: #1e293b;
            --text-light: #64748b;
            --bg-main: #f8fafc;
            --white: #ffffff;
            --sidebar-width: 300px;
            --radius: 16px;
        }

        * { box-sizing: border-box; outline: none; }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-dark);
            margin: 0; padding: 0;
            display: flex; height: 100vh; overflow: hidden;
        }

        /* --- Sidebar (القائمة الجانبية) --- */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--gradient-main);
            color: white;
            display: flex; flex-direction: column;
            box-shadow: 4px 0 20px rgba(2, 118, 128, 0.15);
            z-index: 100; flex-shrink: 0;
            transition: 0.3s;
        }

        .sidebar-header {
            padding: 30px 20px;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            display: flex; align-items: center; gap: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.15);
        }

        .logo-icon {
            width: 45px; height: 45px;
            background: white; border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            color: var(--color-1); box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .logo-icon svg { width: 26px; fill: currentColor; }

        .sidebar-title h1 { margin: 0; font-size: 1.1rem; font-weight: 800; letter-spacing: 0.5px; }
        .sidebar-title p { margin: 2px 0 0; font-size: 0.8rem; opacity: 0.8; font-weight: 300; }

        .sidebar-menu { flex: 1; overflow-y: auto; padding: 15px 10px; }
        .sidebar-menu::-webkit-scrollbar { width: 4px; }
        .sidebar-menu::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 10px; }

        .menu-group { margin-bottom: 8px; }
        .menu-btn {
            width: 100%; background: transparent; border: none; padding: 14px 20px;
            color: white; text-align: right; cursor: pointer; font-family: inherit; font-size: 0.95rem; font-weight: 500;
            display: flex; justify-content: space-between; align-items: center;
            border-radius: 12px; transition: 0.3s ease;
        }
        .menu-btn:hover { background: rgba(255,255,255,0.1); transform: translateX(-5px); }
        .menu-btn.active { background: white; color: var(--color-1); box-shadow: 0 4px 15px rgba(0,0,0,0.1); font-weight: 700; transform: translateX(0); }
        .menu-btn.active .arrow-icon { fill: var(--color-1); transform: rotate(-90deg); }
        
        .arrow-icon { width: 10px; fill: rgba(255,255,255,0.7); transition: 0.3s; }

        .submenu { 
            display: none; margin-top: 5px; background: rgba(0,0,0,0.15); 
            border-radius: 10px; overflow: hidden; 
        }
        .submenu.open { display: block; animation: slideDown 0.3s ease; }
        .sub-item {
            display: block; padding: 12px 20px 12px 15px; color: rgba(255,255,255,0.9);
            text-decoration: none; font-size: 0.9rem; cursor: pointer; transition: 0.2s;
            border-left: 3px solid transparent;
        }
        .sub-item:hover { background: rgba(255,255,255,0.05); padding-right: 25px; }
        .sub-item.current { background: rgba(255,255,255,0.1); border-left-color: var(--color-3); color: white; font-weight: bold; }

        /* --- Main Content (المحتوى الرئيسي) --- */
        .main-content { flex: 1; display: flex; flex-direction: column; height: 100vh; overflow: hidden; background: var(--bg-main); }

        /* Top Bar */
        .top-bar {
            background: var(--white); padding: 15px 40px; display: flex; justify-content: space-between;
            align-items: center; box-shadow: 0 2px 15px rgba(0,0,0,0.03); z-index: 90;
        }
        
        .search-wrapper { position: relative; width: 350px; }
        .search-wrapper input {
            width: 100%; padding: 12px 45px 12px 20px; border-radius: 30px; 
            border: 1px solid #e2e8f0; background: #f8fafc; transition: 0.3s;
            font-family: inherit; font-size: 0.95rem;
        }
        .search-wrapper input:focus { border-color: var(--color-2); background: white; box-shadow: 0 0 0 4px rgba(73, 186, 170, 0.1); }
        .search-icon { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); width: 18px; fill: #94a3b8; }

        .btn-print {
            background: var(--white); color: var(--color-1); border: 1px solid var(--color-1);
            padding: 10px 20px; border-radius: 30px; cursor: pointer; font-weight: bold; font-family: inherit;
            display: flex; align-items: center; gap: 8px; transition: 0.3s;
        }
        .btn-print:hover { background: var(--color-1); color: white; }

        /* Scroll Area */
        .scroll-area { flex: 1; overflow-y: auto; padding: 0; scroll-behavior: smooth; }

        /* --- Hero Section (المقدمة) --- */
        .hero-section {
            background: white;
            margin: 30px 40px;
            padding: 40px;
            border-radius: 24px;
            box-shadow: 0 10px 30px rgba(2, 118, 128, 0.06);
            background-image: linear-gradient(120deg, #fff 0%, #f0fdfa 100%);
            border: 1px solid #e6f7f5;
            position: relative;
            overflow: hidden;
        }
        .hero-section::before {
            content: ''; position: absolute; top: 0; left: 0; width: 6px; height: 100%;
            background: var(--gradient-accent);
        }
        
        .hero-title { font-size: 1.8rem; font-weight: 800; color: var(--color-1); margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .hero-content { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; }
        .hero-text h3 { font-size: 1.2rem; color: var(--color-2); margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
        .hero-text p { color: var(--text-light); line-height: 1.8; font-size: 1rem; margin-bottom: 0; text-align: justify; }
        
        /* Grid */
        .grid-container { padding: 0 40px 60px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 25px; }

        /* Card Style */
        .card {
            background: white; border-radius: 16px; padding: 25px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); border: 1px solid #f1f5f9;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer; position: relative; overflow: hidden;
            display: flex; flex-direction: column;
        }
        .card:hover { transform: translateY(-8px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); border-color: var(--color-2); }
        .card::after { content: ''; position: absolute; bottom: 0; right: 0; width: 100%; height: 4px; background: var(--gradient-accent); transform: scaleX(0); transition: 0.3s; transform-origin: right; }
        .card:hover::after { transform: scaleX(1); }

        .card-header-row { display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px; }
        .provider-badge { font-size: 0.75rem; background: #f0fdfa; color: var(--color-1); padding: 5px 12px; border-radius: 20px; font-weight: bold; border: 1px solid #ccfbf1; }
        
        .card h3 { margin: 0 0 8px; font-size: 1.15rem; color: var(--text-dark); line-height: 1.5; font-weight: 700; }
        .card p { font-size: 0.9rem; color: var(--text-light); line-height: 1.6; margin-bottom: 20px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

        .card-footer { margin-top: auto; padding-top: 15px; border-top: 1px solid #f1f5f9; display: flex; justify-content: space-between; font-size: 0.85rem; color: #64748b; }
        .icon-label { display: flex; align-items: center; gap: 6px; }
        .icon-label svg { width: 16px; fill: var(--color-2); }

        /* Modal */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.6); z-index: 1000;
            backdrop-filter: blur(4px); align-items: center; justify-content: center;
        }
        .modal-box {
            background: white; width: 90%; max-width: 800px; max-height: 90vh;
            border-radius: 20px; overflow-y: auto; position: relative;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            animation: fadeIn 0.3s;
        }
        .modal-header {
            background: var(--gradient-main); color: white; padding: 30px;
            position: sticky; top: 0; z-index: 10;
            display: flex; justify-content: space-between; align-items: start;
        }
        .close-btn { background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; transition: 0.3s; }
        .close-btn:hover { background: white; color: var(--color-1); }

        .modal-body { padding: 40px; }
        
        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .info-card { background: #f8fafc; padding: 15px; border-radius: 12px; border: 1px solid #e2e8f0; }
        .lbl { font-size: 0.8rem; color: #64748b; margin-bottom: 5px; display: block; }
        .val { font-weight: 700; color: var(--color-1); font-size: 1rem; }

        .section-title { font-size: 1.2rem; color: var(--color-1); border-bottom: 2px solid #e2e8f0; padding-bottom: 10px; margin: 30px 0 20px; font-weight: 800; display: flex; align-items: center; gap: 10px; }
        .text-content { line-height: 1.8; color: #334155; font-size: 1rem; white-space: pre-line; }

        .btn-link { display: block; width: 100%; text-align: center; background: var(--color-1); color: white; padding: 16px; border-radius: 12px; text-decoration: none; font-weight: bold; margin-top: 30px; transition: 0.3s; }
        .btn-link:hover { background: var(--color-2); }

        /* Loader */
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .spinner { width: 50px; height: 50px; border: 4px solid #f3f3f3; border-top: 4px solid var(--color-3); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        /* Print */
        @media print {
            .sidebar, .top-bar, .modal-overlay, .hero-section { display: none !important; }
            #print-section { display: block !important; }
            .main-content { height: auto; overflow: visible; }
            table { width: 100%; border-collapse: collapse; margin-top: 20px; direction: rtl; }
            th, td { border: 1px solid #ccc; padding: 10px; text-align: right; }
            th { background: #eee; }
        }
        #print-section { display: none; padding: 40px; }

        @media (max-width: 900px) {
            .hero-content { grid-template-columns: 1fr; gap: 20px; }
        }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <p>جاري تحميل الدليل...</p>
    </div>

    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="logo-icon">
                <svg viewBox="0 0 24 24"><path d="M12 3L1 9l11 6 9-4.91V17h2V9M5 13.18v4L12 21l7-3.82v-4L12 17l-7-3.82Z"/></svg>
            </div>
            <div class="sidebar-title">
                <h1>الدليل المهني</h1>
                <p>جامعة الأميرة نورة</p>
            </div>
        </div>
        <div class="sidebar-menu" id="sidebarMenu">
            <!-- Menu Items Generated Here -->
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <div class="top-bar">
            <div class="search-wrapper">
                <input type="text" id="searchInput" placeholder="ابحث باسم الشهادة، الجهة، أو القسم..." onkeyup="handleSearch()">
                <svg class="search-icon" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
            </div>
            <button class="btn-print" onclick="printGuide()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M19 8h-1V3H6v5H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zM8 5h8v3H8V5zm8 12v2H8v-4h8v2zm2-2v-2H6v2H4v-4c0-.55.45-1 1-1h14c.55 0 1 .45 1 1v4h-2z"/></svg>
                تصدير PDF
            </button>
        </div>

        <div class="scroll-area">
            
            <!-- Hero Section (المقدمة) -->
            <div class="hero-section">
                <div class="hero-title">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="#49baaa"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
                    دليل الشهادات الاحترافية
                </div>
                <div class="hero-content">
                    <div class="hero-text">
                        <h3><svg width="20" viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg> مقدمة</h3>
                        <p>يهدف هذا الدليل إلى تسليط الضوء على الشهادات الاحترافية المهمة في مختلف التخصصات، مع التركيز على كيفية استفادة طالبات جامعة الأميرة نورة بنت عبد الرحمن من هذه الشهادات لدعم رحلتهن الأكاديمية والمهنية. يقدم الدليل معلومات شاملة عن المتطلبات والإجراءات والجهات المانحة لكل شهادة.</p>
                    </div>
                    <div class="hero-text">
                        <h3><svg width="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 7V3H2v18h20V7H12zM6 19H4v-2h2v2zm0-4H4v-2h2v2zm0-4H4V9h2v2zm0-4H4V5h2v2zm4 12H8v-2h2v2zm0-4H8v-2h2v2zm0-4H8V9h2v2zm0-4H8V5h2v2zm10 12h-8v-2h2v-2h-2v-2h2v-2h-2V9h8v10zm-2-8h-2v2h2v-2zm0 4h-2v2h2v-2z"/></svg> نبذة عن الدليل وأهدافه</h3>
                        <p>تم إعداد هذا الدليل لتقديم قائمة شاملة من الشهادات الاحترافية في تخصصات متنوعة، كإدارة الأعمال، تقنية المعلومات، والهندسة. يهدف إلى دعم الطالبات في اختيار الشهادات الأنسب لتعزيز مهاراتهن المهنية وتحقيق جاهزية لسوق العمل.</p>
                    </div>
                </div>
            </div>

            <!-- Grid Container -->
            <div class="grid-container">
                <h3 id="sectionTitle" style="margin-bottom:20px; color:var(--text-light);">اختر قسماً لعرض الشهادات</h3>
                <div class="grid" id="cardsGrid">
                    <!-- Cards will appear here -->
                </div>
            </div>
        </div>
    </main>

    <!-- Modal Details -->
    <div class="modal-overlay" id="certModal">
        <div class="modal-box">
            <div class="modal-header">
                <div>
                    <h2 id="m-title" style="margin:0; font-size:1.4rem; font-weight:800;"></h2>
                    <p id="m-sub" style="margin:5px 0 0; opacity:0.9; font-weight:300;"></p>
                </div>
                <button class="close-btn" onclick="closeModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="info-grid">
                    <div class="info-card"><span class="lbl">الجهة المانحة</span><span class="val" id="m-provider"></span></div>
                    <div class="info-card"><span class="lbl">المستوى</span><span class="val" id="m-level"></span></div>
                    <div class="info-card"><span class="lbl">التكلفة</span><span class="val" id="m-cost"></span></div>
                    <div class="info-card"><span class="lbl">اللغة</span><span class="val" id="m-lang"></span></div>
                </div>

                <div class="section-title"><svg width="24" viewBox="0 0 24 24" fill="currentColor"><path d="M14 17H4v2h10v-2zm6-8H4v2h16V9zM4 15h16v-2H4v2zM4 5v2h16V5H4z"/></svg> نبذة عن الشهادة</div>
                <div class="text-content" id="m-desc"></div>

                <div class="section-title"><svg width="24" viewBox="0 0 24 24" fill="currentColor"><path d="M4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm16-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-1 9H9V9h10v2zm-4 4H9v-2h6v2zm4-8H9V5h10v2z"/></svg> الموضوعات</div>
                <div class="text-content" id="m-topics"></div>

                <div class="info-grid" style="margin-top:30px;">
                    <div class="info-card"><span class="lbl">مدة الاختبار</span><span class="val" id="m-dur"></span></div>
                    <div class="info-card"><span class="lbl">عدد الأسئلة</span><span class="val" id="m-q"></span></div>
                    <div class="info-card"><span class="lbl">الصلاحية</span><span class="val" id="m-valid"></span></div>
                </div>

                <a href="#" id="m-link" target="_blank" class="btn-link">زيارة الموقع الرسمي للشهادة</a>
            </div>
        </div>
    </div>

    <!-- Print Layout -->
    <div id="print-section">
        <div style="text-align:center; margin-bottom:40px; border-bottom:3px solid #027680; padding-bottom:20px;">
            <h1 style="color:#027680;">دليل الشهادات المهنية</h1>
            <p>جامعة الأميرة نورة بنت عبدالرحمن</p>
        </div>
        <table id="printTable">
            <thead>
                <tr>
                    <th>الكلية</th>
                    <th>القسم</th>
                    <th>الشهادة</th>
                    <th>الجهة المانحة</th>
                    <th>المستوى</th>
                </tr>
            </thead>
            <tbody id="printBody"></tbody>
        </table>
    </div>

<script>
    let db = [];

    // قراءة ملف الإكسل
    async function loadExcelData() {
        try {
            const response = await fetch('./data.xlsx');
            
            if (!response.ok) {
                // في حالة عدم وجود الملف، استخدم قاعدة بيانات فارغة لتجنب تعطل الصفحة
                console.warn("لم يتم العثور على data.xlsx، سيتم استخدام واجهة فارغة.");
                document.getElementById('loader').style.display = 'none';
                initSidebar();
                return;
            }

            const arrayBuffer = await response.arrayBuffer();
            const workbook = XLSX.read(arrayBuffer, { type: 'array' });
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            
            db = XLSX.utils.sheet_to_json(worksheet);
            console.log("تم تحميل", db.length, "سجل");
            
            document.getElementById('loader').style.display = 'none';
            initSidebar();
            
        } catch (error) {
            console.error(error);
            document.getElementById('loader').innerHTML = `<p style="color:red">خطأ في تحميل البيانات</p>`;
        }
    }

    // بناء القائمة الجانبية
    function initSidebar() {
        const menuContainer = document.getElementById('sidebarMenu');
        menuContainer.innerHTML = ''; 
        
        // استخراج الكليات
        const colleges = [...new Set(db.map(item => item.college))].filter(Boolean);

        colleges.forEach(college => {
            const group = document.createElement('div');
            group.className = 'menu-group';

            const btn = document.createElement('button');
            btn.className = 'menu-btn';
            btn.innerHTML = `<span>${college}</span> <svg class="arrow-icon" viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg>`;
            
            const submenu = document.createElement('div');
            submenu.className = 'submenu';
            
            // خيار عرض الكل
            submenu.innerHTML += `<a class="sub-item" onclick="filterByDept('${college}', 'all', this)">عرض جميع الشهادات</a>`;

            // الأقسام
            const depts = [...new Set(db.filter(i => i.college === college).map(i => i.department))].filter(Boolean);
            
            depts.forEach(dept => {
                submenu.innerHTML += `<a class="sub-item" onclick="filterByDept('${college}', '${dept}', this)">${dept}</a>`;
            });

            btn.onclick = () => {
                // إغلاق القوائم الأخرى (Accordion Effect)
                const isOpen = submenu.classList.contains('open');
                document.querySelectorAll('.submenu').forEach(s => s.classList.remove('open'));
                document.querySelectorAll('.menu-btn').forEach(b => {
                    b.classList.remove('active');
                    b.querySelector('.arrow-icon').style.transform = 'rotate(0deg)';
                });
                
                if(!isOpen) {
                    submenu.classList.add('open');
                    btn.classList.add('active');
                    btn.querySelector('.arrow-icon').style.transform = 'rotate(-90deg)';
                }
            };

            group.appendChild(btn);
            group.appendChild(submenu);
            menuContainer.appendChild(group);
        });
    }

    // فلترة وعرض البطاقات
    function filterByDept(college, dept, element) {
        // Highlighting Active Item
        document.querySelectorAll('.sub-item').forEach(i => i.classList.remove('current'));
        element.classList.add('current');

        // Scroll to Grid
        document.querySelector('.grid-container').scrollIntoView({ behavior: 'smooth' });

        // Update Title
        const titleSec = document.getElementById('sectionTitle');
        titleSec.innerHTML = dept === 'all' ? `جميع شهادات: <span style="color:#027680">${college}</span>` : `قسم: <span style="color:#027680">${dept}</span>`;

        // Filter Data
        let filtered = db.filter(i => i.college === college);
        if(dept !== 'all') {
            filtered = filtered.filter(i => i.department === dept);
        }
        renderCards(filtered);
    }

    // البحث
    function handleSearch() {
        const q = document.getElementById('searchInput').value.toLowerCase();
        if(q.length < 2) return;

        // Scroll to Grid
        document.querySelector('.grid-container').scrollIntoView({ behavior: 'smooth' });
        document.getElementById('sectionTitle').innerText = 'نتائج البحث...';

        const filtered = db.filter(item => 
            (item.title_ar && item.title_ar.toString().toLowerCase().includes(q)) ||
            (item.title_en && item.title_en.toString().toLowerCase().includes(q)) ||
            (item.provider && item.provider.toString().toLowerCase().includes(q)) ||
            (item.department && item.department.toString().toLowerCase().includes(q))
        );
        renderCards(filtered);
    }

    // رسم البطاقات
    function renderCards(data) {
        const grid = document.getElementById('cardsGrid');
        grid.innerHTML = '';

        if(data.length === 0) {
            grid.innerHTML = `<div style="text-align:center; color:#999; grid-column:1/-1; padding:20px;">لا توجد نتائج مطابقة</div>`;
            return;
        }

        data.forEach(item => {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <div class="card-header-row">
                    <span class="provider-badge">${item.provider || 'N/A'}</span>
                </div>
                <h3>${item.title_ar || item.title_en}</h3>
                <p>${item.description ? item.description.substring(0, 100) + '...' : 'لا يوجد وصف متاح'}</p>
                <div class="card-footer">
                    <div class="icon-label">
                        <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 14H9V8h2v8zm4 0h-2V8h2v8z"/></svg>
                        ${item.level || '-'}
                    </div>
                    <div class="icon-label">
                        <svg viewBox="0 0 24 24"><path d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"/></svg>
                        ${item.cost || '-'}
                    </div>
                </div>
            `;
            card.onclick = () => openModal(item);
            grid.appendChild(card);
        });
    }

    // فتح النافذة المنبثقة
    function openModal(item) {
        document.getElementById('m-title').innerText = item.title_ar || item.title_en;
        document.getElementById('m-sub').innerText = item.title_ar ? item.title_en : '';
        document.getElementById('m-desc').innerText = item.description || 'لا يوجد وصف';
        document.getElementById('m-provider').innerText = item.provider || '-';
        document.getElementById('m-level').innerText = item.level || '-';
        document.getElementById('m-cost').innerText = item.cost || '-';
        document.getElementById('m-lang').innerText = item.language || '-';
        document.getElementById('m-topics').innerText = item.topics || 'غير محدد';
        document.getElementById('m-dur').innerText = item.exam_duration || '-';
        document.getElementById('m-q').innerText = item.questions_count || '-';
        document.getElementById('m-valid').innerText = item.validity || '-';

        const btn = document.getElementById('m-link');
        if(item.link && item.link.length > 5 && !item.link.includes('NO MATCH')) {
            btn.href = item.link;
            btn.style.display = 'block';
        } else {
            btn.style.display = 'none';
        }
        document.getElementById('certModal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('certModal').style.display = 'none';
    }

    window.onclick = function(e) {
        if(e.target == document.getElementById('certModal')) closeModal();
    }

    // طباعة PDF
    function printGuide() {
        const tbody = document.getElementById('printBody');
        tbody.innerHTML = '';
        db.forEach(item => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${item.college || '-'}</td>
                <td>${item.department || '-'}</td>
                <td>${item.title_ar || item.title_en}</td>
                <td>${item.provider || '-'}</td>
                <td>${item.level || '-'}</td>
            `;
            tbody.appendChild(tr);
        });
        window.print();
    }

    // تشغيل التطبيق
    loadExcelData();

</script>

</body>
</html>
