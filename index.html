<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>دليل الشهادات الاحترافية - جامعة الأميرة نورة</title>
    
    <!-- الخطوط -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    
    <!-- مكتبة الأيقونات -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- مكتبة Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --color-1: #027680;
            --color-2: #49baaa;
            --color-3: #42b677;
            --gradient-main: linear-gradient(135deg, var(--color-1) 0%, var(--color-2) 100%);
            --gradient-sidebar: linear-gradient(180deg, var(--color-1) 0%, var(--color-2) 100%);
            --text-dark: #1e293b;
            --text-light: #64748b;
            --bg-main: #f8fafc;
            --sidebar-width: 300px;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-dark);
            margin: 0; padding: 0;
            display: flex; height: 100vh; overflow: hidden;
        }

        /* --- Sidebar --- */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--gradient-sidebar);
            color: white;
            display: flex; flex-direction: column;
            box-shadow: 4px 0 20px rgba(0,0,0,0.1);
            z-index: 2000; flex-shrink: 0;
            height: 100%;
            transition: transform 0.3s ease-in-out;
        }

        .sidebar-header {
            padding: 25px 20px;
            background: rgba(255,255,255,0.1);
            display: flex; align-items: center; gap: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .logo-box {
            width: 40px; height: 40px;
            background: white; border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            color: var(--color-1); font-size: 20px;
        }

        .sidebar-title h1 { margin: 0; font-size: 1rem; font-weight: 800; }
        .sidebar-title p { margin: 2px 0 0; font-size: 0.75rem; opacity: 0.8; }

        .sidebar-menu { 
            flex: 1; overflow-y: auto; padding: 10px; 
            -webkit-overflow-scrolling: touch;
        }
        
        .menu-btn {
            width: 100%; background: transparent; border: none; padding: 14px 15px;
            color: white; text-align: right; cursor: pointer; font-family: inherit; font-size: 0.95rem; font-weight: 500;
            display: flex; justify-content: space-between; align-items: center;
            border-radius: 10px; transition: 0.2s; margin-bottom: 5px;
        }
        .menu-btn:hover { background: rgba(255,255,255,0.1); }
        .menu-btn.active { background: white; color: var(--color-1); font-weight: bold; }
        .menu-btn.active i { transform: rotate(-90deg); color: var(--color-1); }
        
        .submenu { display: none; margin-top: 2px; background: rgba(0,0,0,0.2); border-radius: 10px; overflow: hidden; margin-bottom: 8px; }
        .submenu.open { display: block; }
        
        .sub-item {
            display: block; padding: 12px 20px 12px 15px; color: rgba(255,255,255,0.9);
            text-decoration: none; font-size: 0.9rem; cursor: pointer;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .sub-item:last-child { border-bottom: none; }
        .sub-item.current { background: rgba(255,255,255,0.15); border-right: 4px solid var(--color-3); color: white; font-weight: bold; }

        /* Overlay */
        .sidebar-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1500; backdrop-filter: blur(3px);
        }
        .sidebar-overlay.active { display: block; }

        /* --- Main Content --- */
        .main-content { flex: 1; display: flex; flex-direction: column; height: 100vh; overflow: hidden; position: relative; }

        .top-bar {
            background: white; padding: 10px 20px; 
            display: flex; justify-content: space-between; align-items: center; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
            z-index: 900; position: sticky; top: 0; height: 70px; flex-shrink: 0;
        }

        .mobile-menu-btn {
            display: none; background: none; border: none; font-size: 1.4rem; color: var(--color-1); cursor: pointer; padding: 5px;
        }
        
        .search-wrapper { position: relative; flex: 1; max-width: 400px; margin: 0 15px; }
        .search-wrapper input {
            width: 100%; padding: 10px 40px 10px 15px; border-radius: 30px; 
            border: 1px solid #e2e8f0; background: #f8fafc; transition: 0.3s; font-family: inherit; font-size: 0.9rem;
        }
        .search-wrapper input:focus { border-color: var(--color-2); background: white; }
        .search-icon { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #94a3b8; }

        .btn-print {
            background: white; color: var(--color-1); border: 1px solid var(--color-1);
            padding: 8px 15px; border-radius: 30px; cursor: pointer; font-weight: bold; font-family: inherit;
            display: flex; align-items: center; gap: 8px; transition: 0.3s; white-space: nowrap; font-size: 0.85rem;
        }

        .scroll-area { flex: 1; overflow-y: auto; padding: 0; scroll-behavior: smooth; -webkit-overflow-scrolling: touch; }

        /* Hero */
        .hero-section {
            background: white; margin: 20px; padding: 25px;
            border-radius: 16px; box-shadow: 0 4px 15px rgba(2, 118, 128, 0.05);
            border-top: 4px solid var(--color-2);
        }
        .hero-title { font-size: 1.1rem; font-weight: 800; color: var(--color-1); margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
        .hero-title i { color: var(--color-3); font-size: 1.2rem; }
        .hero-text { color: var(--text-light); line-height: 1.7; font-size: 0.9rem; text-align: justify; }

        /* Grid */
        .grid-container { padding: 10px 20px 80px; }
        .grid-header { margin-bottom: 15px; color: var(--text-light); font-weight: bold; font-size: 0.95rem; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }

        .card {
            background: white; border-radius: 14px; padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03); border: 1px solid #f1f5f9;
            transition: 0.2s; cursor: pointer; display: flex; flex-direction: column;
            position: relative; overflow: hidden;
        }
        .card::before { content: ''; position: absolute; left: 0; top: 0; height: 100%; width: 4px; background: var(--gradient-main); opacity: 0.8; }
        .provider-badge { font-size: 0.7rem; background: #e0f2f1; color: var(--color-1); padding: 4px 8px; border-radius: 6px; font-weight: bold; align-self: flex-start; margin-bottom: 10px; }
        .card h3 { margin: 0 0 8px; font-size: 1.05rem; color: var(--text-dark); line-height: 1.4; font-weight: 700; }
        .card p { font-size: 0.85rem; color: var(--text-light); line-height: 1.5; margin-bottom: 15px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .card-footer { margin-top: auto; padding-top: 10px; border-top: 1px solid #f1f5f9; display: flex; justify-content: space-between; font-size: 0.8rem; color: #64748b; }
        .footer-item { display: flex; align-items: center; gap: 5px; }
        .footer-item i { color: var(--color-2); }

        /* Modal */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 3500; backdrop-filter: blur(3px);
            align-items: center; justify-content: center;
        }
        .modal-box {
            background: white; width: 95%; max-width: 700px; max-height: 90vh;
            border-radius: 16px; overflow-y: auto; animation: fadeIn 0.2s;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        .modal-header {
            background: var(--gradient-main); color: white; padding: 15px 20px;
            display: flex; justify-content: space-between; align-items: start; position: sticky; top: 0; z-index: 10;
        }
        .close-btn { background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 1.2rem; }
        .modal-body { padding: 20px; }
        .info-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px; }
        .info-item { background: #f8fafc; padding: 10px; border-radius: 8px; border: 1px solid #e2e8f0; text-align: center; }
        .info-item i { color: var(--color-2); font-size: 1.1rem; margin-bottom: 4px; display: block; }
        .info-item span { display: block; font-size: 0.7rem; color: #64748b; }
        .info-item strong { display: block; font-size: 0.85rem; color: var(--text-dark); margin-top: 2px; }
        .topics-list { line-height: 1.6; color: #334155; font-size: 0.9rem; padding-right: 18px; margin: 0; }
        .modal-text { line-height: 1.6; color: #334155; font-size: 0.9rem; white-space: pre-line; text-align: justify; }
        .courses-container { display: flex; flex-wrap: wrap; gap: 6px; }
        .course-badge { background: #e6fffa; color: #027680; border: 1px solid #49baaa; padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; font-weight: bold; }
        .modal-actions { display: flex; flex-direction: column; gap: 10px; margin-top: 25px; }
        .btn-link, .btn-modal-print { width: 100%; text-align: center; padding: 12px; border-radius: 10px; font-weight: bold; text-decoration: none; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.95rem; }
        .btn-link { background: var(--color-1); color: white; }
        .btn-modal-print { border: 2px solid var(--color-1); background: white; color: var(--color-1); cursor: pointer; }

        /* --- Mobile Responsive Rules --- */
        @media (max-width: 900px) {
            .sidebar { 
                position: fixed; right: -320px; top: 0; height: 100%; width: 280px; 
                transition: transform 0.3s ease-in-out; transform: translateX(0);
            }
            .sidebar.active { transform: translateX(-320px); }
            
            .mobile-menu-btn { display: block; }
            .btn-print span { display: none; } 
            .btn-print { padding: 0; width: 40px; height: 40px; justify-content: center; border-radius: 50%; }
            .search-wrapper { margin: 0 10px; }
        }

        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .spinner { width: 40px; height: 40px; border: 3px solid #f3f3f3; border-top: 3px solid var(--color-2); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        /* ========================
           PRINT STYLES (TABLE ONLY - CLEAN)
           ======================== */
        @media print {
            .sidebar, .top-bar, .hero-section, .modal-overlay, .mobile-menu-btn { display: none !important; }
            body, .main-content { background: white; height: auto; overflow: visible; margin: 0; padding: 0; display: block; }
            #print-container { display: block !important; padding: 10px; width: 100%; }
            
            .print-header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 15px; }
            .print-header h1 { font-size: 16pt; margin: 0; }
            .print-header p { font-size: 11pt; margin: 5px 0; }

            table { width: 100%; border-collapse: collapse; direction: rtl; }
            th, td { border: 1px solid #000; padding: 6px; text-align: right; font-size: 9pt; vertical-align: top; }
            th { background-color: #f0f0f0 !important; font-weight: bold; -webkit-print-color-adjust: exact; }
            
            th:nth-child(1) { width: 15%; } /* الكلية */
            th:nth-child(2) { width: 15%; } /* القسم */
            th:nth-child(3) { width: 25%; } /* الشهادة */
            th:nth-child(4) { width: 30%; } /* التفاصيل */
            th:nth-child(5) { width: 15%; } /* المستوى */
        }

        #print-container { display: none; }

    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <p>جاري تحميل البيانات...</p>
    </div>

    <!-- Mobile Sidebar Overlay -->
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="logo-box">
                <i class="fas fa-university"></i>
            </div>
            <div class="sidebar-title">
                <h1>دليل الشهادت الاحترافية</h1>
                <p>جامعة الأميرة نورة</p>
            </div>
        </div>
        <div class="sidebar-menu" id="sidebarMenu"></div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <div class="top-bar">
            <!-- Mobile Toggle -->
            <button class="mobile-menu-btn" onclick="toggleSidebar()">
                <i class="fas fa-bars"></i>
            </button>

            <div class="search-wrapper">
                <input type="text" id="searchInput" placeholder="بحث شامل..." onkeyup="handleSearch()">
                <i class="fas fa-search search-icon"></i>
            </div>
            <button class="btn-print" onclick="printList()">
                <i class="fas fa-file-pdf"></i> <span>تصدير القائمة</span>
            </button>
        </div>

        <div class="scroll-area">
            <div class="hero-section">
                <div class="hero-block">
                    <div class="hero-title"><i class="fas fa-book-open"></i> مقدمة</div>
                    <div class="hero-text">يهدف هذا الدليل إلى تسليط الضوء على الشهادات الاحترافية المهمة في مختلف التخصصات، مع التركيز على كيفية استفادة طالبات جامعة الأميرة نورة بنت عبد الرحمن من هذه الشهادات لدعم رحلتهن الأكاديمية والمهنية.</div>
                </div>
                <hr style="border:0; border-top:1px solid #e2e8f0; margin: 15px 0;">
                <div class="hero-block">
                    <div class="hero-title"><i class="fas fa-bullseye"></i> نبذة عن الدليل وأهدافه</div>
                    <div class="hero-text">تم إعداد هذا الدليل لتقديم قائمة شاملة من الشهادات الاحترافية في تخصصات متنوعة، كإدارة الأعمال، تقنية المعلومات، والهندسة. يهدف إلى دعم الطالبات في اختيار الشهادات الأنسب لتعزيز مهاراتهن المهنية وتحقيق جاهزية لسوق العمل.</div>
                </div>
            </div>

            <div class="grid-container">
                <div class="grid-header" id="sectionTitle">
                    <i class="fas fa-th-large"></i> اختر كلية وقسماً لعرض الشهادات
                </div>
                <div class="grid" id="cardsGrid"></div>
            </div>
        </div>
    </main>

    <!-- Modal (Popup) -->
    <div class="modal-overlay" id="certModal">
        <div class="modal-box">
            <div class="modal-header">
                <div>
                    <h2 id="m-title" style="margin:0; font-size:1.1rem;"></h2>
                    <p id="m-sub" style="margin:2px 0 0; opacity:0.9; font-weight:300; font-size:0.85rem;"></p>
                </div>
                <button class="close-btn" onclick="closeModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                
                <div class="info-grid">
                    <div class="info-item"><i class="fas fa-building"></i><span>الجهة المانحة</span><strong id="m-provider"></strong></div>
                    <div class="info-item"><i class="fas fa-chart-simple"></i><span>المستوى</span><strong id="m-level"></strong></div>
                    <div class="info-item"><i class="fas fa-money-bill-wave"></i><span>التكلفة</span><strong id="m-cost"></strong></div>
                    <div class="info-item"><i class="fas fa-globe"></i><span>اللغة</span><strong id="m-lang"></strong></div>
                    <div class="info-item"><i class="fas fa-laptop-code"></i><span>آلية التنفيذ</span><strong id="m-mode"></strong></div>
                    <div class="info-item"><i class="fas fa-hand-holding-dollar"></i><span>دعم هدف</span><strong id="m-support"></strong></div>
                </div>

                <div class="modal-section">
                    <h4><i class="fas fa-info-circle"></i> نبذة عن الشهادة</h4>
                    <div class="modal-text" id="m-desc"></div>
                </div>

                <div class="modal-section">
                    <h4><i class="fas fa-list-check"></i> المتطلبات</h4>
                    <div class="modal-text" id="m-req"></div>
                </div>

                <div class="modal-section">
                    <h4><i class="fas fa-list-ul"></i> الموضوعات</h4>
                    <div id="m-topics"></div>
                </div>

                <div class="info-grid" style="margin-bottom:20px;">
                    <div class="info-item"><i class="fas fa-hourglass-half"></i><span>مدة الاختبار</span><strong id="m-dur"></strong></div>
                    <div class="info-item"><i class="fas fa-question-circle"></i><span>الأسئلة</span><strong id="m-q"></strong></div>
                    <div class="info-item"><i class="fas fa-vial"></i><span>نوع الأسئلة</span><strong id="m-qtype"></strong></div>
                    <div class="info-item"><i class="fas fa-calendar-check"></i><span>الصلاحية</span><strong id="m-valid"></strong></div>
                </div>

                <div class="modal-section">
                    <h4><i class="fas fa-user-plus"></i> إجراءات التقديم</h4>
                    <div class="modal-text" id="m-reg"></div>
                </div>

                <div class="modal-section">
                    <h4><i class="fas fa-book"></i> المصادر التعليمية</h4>
                    <div class="modal-text" id="m-res"></div>
                </div>

                <div class="modal-section">
                    <h4><i class="fas fa-graduation-cap"></i> المقررات المرتبطة</h4>
                    <div class="courses-container" id="m-courses"></div>
                </div>

                <div class="modal-actions">
                    <button class="btn-modal-print" onclick="printSingleCert()">
                        <i class="fas fa-file-pdf"></i> تصدير الشهادة (جدول)
                    </button>
                    <a href="#" id="m-link" target="_blank" class="btn-link">
                        <i class="fas fa-external-link-alt"></i> زيارة الموقع الرسمي
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Unified Print Container (Always Table) -->
    <div id="print-container">
        <div class="print-header">
            <h1>تقرير الشهادات المهنية</h1>
            <p>جامعة الأميرة نورة بنت عبدالرحمن</p>
            <p id="print-subtitle" style="font-size:10pt; margin-top:5px;"></p>
        </div>
        <table id="print-table">
            <thead id="print-thead"></thead>
            <tbody id="print-tbody"></tbody>
        </table>
    </div>

<script>
    let db = [];
    let currentData = [];
    let selectedCert = null;

    async function loadExcelData() {
        try {
            const response = await fetch('./data.xlsx');
            if (!response.ok) {
                console.warn("Using empty DB");
                document.getElementById('loader').style.display = 'none';
                initSidebar();
                return;
            }
            const arrayBuffer = await response.arrayBuffer();
            const workbook = XLSX.read(arrayBuffer, { type: 'array' });
            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
            db = XLSX.utils.sheet_to_json(worksheet);
            currentData = []; 
            document.getElementById('loader').style.display = 'none';
            initSidebar();
        } catch (error) {
            console.error(error);
            document.getElementById('loader').innerHTML = `<p style="color:red">خطأ في تحميل البيانات</p>`;
        }
    }

    function initSidebar() {
        const menuContainer = document.getElementById('sidebarMenu');
        menuContainer.innerHTML = ''; 
        const colleges = [...new Set(db.map(item => item.college))].filter(Boolean);

        colleges.forEach(college => {
            const group = document.createElement('div');
            group.className = 'menu-group';
            const btn = document.createElement('button');
            btn.className = 'menu-btn';
            btn.innerHTML = `<span>${college}</span> <i class="fas fa-chevron-left arrow-icon"></i>`;
            
            const submenu = document.createElement('div');
            submenu.className = 'submenu';
            submenu.innerHTML += `<a class="sub-item" onclick="filterByDept('${college}', 'all', this)">عرض جميع الشهادات</a>`;

            const depts = [...new Set(db.filter(i => i.college === college).map(i => i.department))].filter(Boolean);
            depts.forEach(dept => {
                submenu.innerHTML += `<a class="sub-item" onclick="filterByDept('${college}', '${dept}', this)">${dept}</a>`;
            });

            btn.onclick = () => {
                const isOpen = submenu.classList.contains('open');
                document.querySelectorAll('.submenu').forEach(s => s.classList.remove('open'));
                document.querySelectorAll('.menu-btn').forEach(b => {
                    b.classList.remove('active');
                    b.querySelector('.arrow-icon').style.transform = 'rotate(0deg)';
                });
                
                if(!isOpen) {
                    submenu.classList.add('open');
                    btn.classList.add('active');
                    btn.querySelector('.arrow-icon').style.transform = 'rotate(-90deg)';
                }
            };
            group.appendChild(btn);
            group.appendChild(submenu);
            menuContainer.appendChild(group);
        });
    }

    // Toggle Sidebar on Mobile (Fixed Logic)
    function toggleSidebar() {
        const sidebar = document.querySelector('.sidebar');
        const overlay = document.querySelector('.sidebar-overlay');
        sidebar.classList.toggle('active');
        overlay.classList.toggle('active');
    }

    function filterByDept(college, dept, element) {
        // Close sidebar on mobile and remove active classes
        document.querySelector('.sidebar').classList.remove('active');
        document.querySelector('.sidebar-overlay').classList.remove('active');

        document.querySelectorAll('.sub-item').forEach(i => i.classList.remove('current'));
        element.classList.add('current');
        document.querySelector('.grid-container').scrollIntoView({ behavior: 'smooth' });

        const titleSec = document.getElementById('sectionTitle');
        titleSec.innerHTML = dept === 'all' ? 
            `<i class="fas fa-layer-group"></i> شهادات: <span style="color:var(--color-1)">${college}</span>` : 
            `<i class="fas fa-folder-open"></i> قسم: <span style="color:var(--color-1)">${dept}</span>`;

        let filtered = db.filter(i => i.college === college);
        if(dept !== 'all') {
            filtered = filtered.filter(i => i.department === dept);
        }
        currentData = filtered; 
        renderCards(filtered);
    }

    function handleSearch() {
        const q = document.getElementById('searchInput').value.toLowerCase();
        if(q.length < 2) return;

        document.querySelector('.grid-container').scrollIntoView({ behavior: 'smooth' });
        document.getElementById('sectionTitle').innerHTML = '<i class="fas fa-search"></i> نتائج البحث...';

        const filtered = db.filter(item => 
            (item.title_ar && String(item.title_ar).toLowerCase().includes(q)) ||
            (item.title_en && String(item.title_en).toLowerCase().includes(q)) ||
            (item.provider && String(item.provider).toLowerCase().includes(q))
        );
        currentData = filtered; 
        renderCards(filtered);
    }

    function renderCards(data) {
        const grid = document.getElementById('cardsGrid');
        grid.innerHTML = '';

        if(data.length === 0) {
            grid.innerHTML = `<div style="text-align:center; color:#999; grid-column:1/-1; padding:20px;">لا توجد نتائج مطابقة</div>`;
            return;
        }

        data.forEach(item => {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <span class="provider-badge">${item.provider || 'N/A'}</span>
                <h3>${item.title_ar || item.title_en}</h3>
                <p>${item.description ? item.description.substring(0, 100) + '...' : 'لا يوجد وصف متاح'}</p>
                <div class="card-footer">
                    <div class="footer-item"><i class="fas fa-chart-simple"></i> ${item.level || '-'}</div>
                    <div class="footer-item"><i class="fas fa-money-bill-wave"></i> ${item.cost || '-'}</div>
                </div>
            `;
            // Safe click assignment
            card.onclick = function() { openModal(item); };
            grid.appendChild(card);
        });
    }

    function formatTopicsHTML(text) {
        if (!text) return '<div class="modal-text">غير محدد</div>';
        // Force string conversion to prevent crash on numbers
        let str = String(text);
        let lines = str.split(/\r?\n|•| - /).filter(line => line.trim() !== '');
        if (lines.length === 0) return `<div class="modal-text">${str}</div>`;
        let html = '<ul class="topics-list">';
        lines.forEach(line => {
            let cleanLine = line.trim().replace(/^[\d]+[\.\/]\s*/, '');
            html += `<li>${cleanLine}</li>`;
        });
        html += '</ul>';
        return html;
    }

    function openModal(item) {
        selectedCert = item; 

        document.getElementById('m-title').innerText = item.title_ar || item.title_en;
        document.getElementById('m-sub').innerText = item.title_ar ? item.title_en : '';
        document.getElementById('m-desc').innerText = item.description || 'لا يوجد وصف';
        document.getElementById('m-provider').innerText = item.provider || '-';
        document.getElementById('m-level').innerText = item.level || '-';
        document.getElementById('m-cost').innerText = item.cost || '-';
        document.getElementById('m-lang').innerText = item.language || '-';
        document.getElementById('m-mode').innerText = item.mode || '-';
        document.getElementById('m-support').innerText = item.is_supported || '-';
        
        document.getElementById('m-req').innerText = item.requirements || 'لا يوجد';
        document.getElementById('m-topics').innerHTML = formatTopicsHTML(item.topics);
        document.getElementById('m-reg').innerText = item.registration_steps || '-';
        document.getElementById('m-res').innerText = item.resources || '-';

        document.getElementById('m-dur').innerText = item.exam_duration || '-';
        document.getElementById('m-q').innerText = item.questions_count || '-';
        document.getElementById('m-qtype').innerText = item.questions_type || '-';
        document.getElementById('m-valid').innerText = item.validity || '-';

        const coursesDiv = document.getElementById('m-courses');
        coursesDiv.innerHTML = '';
        for(let i=1; i<=4; i++) {
            if(item[`course_${i}`]) {
                coursesDiv.innerHTML += `<span class="course-badge">${item[`course_${i}`]}</span>`;
            }
        }
        if(coursesDiv.innerHTML === '') coursesDiv.innerHTML = '<span style="color:#999; font-size:0.8rem;">لا يوجد مقررات مرتبطة</span>';

        const btn = document.getElementById('m-link');
        if(item.link && item.link.length > 5 && !item.link.includes('NO MATCH')) {
            btn.href = item.link;
            btn.style.display = 'block';
        } else {
            btn.style.display = 'none';
        }
        document.getElementById('certModal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('certModal').style.display = 'none';
    }

    // ========== SIMPLE TABLE PRINTING ==========

    // 1. Print List (Table)
    function printList() {
        if (currentData.length === 0) {
            alert("لا توجد بيانات معروضة للطباعة.");
            return;
        }
        
        const thead = document.getElementById('print-thead');
        const tbody = document.getElementById('print-tbody');
        document.getElementById('print-subtitle').innerText = `قائمة الشهادات - عدد النتائج: ${currentData.length}`;

        thead.innerHTML = `
            <tr>
                <th width="15%">الكلية</th>
                <th width="15%">القسم</th>
                <th width="35%">اسم الشهادة</th>
                <th width="20%">الجهة المانحة</th>
                <th width="15%">المستوى</th>
            </tr>
        `;

        tbody.innerHTML = '';
        currentData.forEach(item => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${item.college || '-'}</td>
                <td>${item.department || '-'}</td>
                <td>${item.title_ar || item.title_en}</td>
                <td>${item.provider || '-'}</td>
                <td>${item.level || '-'}</td>
            `;
            tbody.appendChild(tr);
        });
        
        window.print();
    }

    // 2. Print Single Cert (Vertical Table)
    function printSingleCert() {
        if (!selectedCert) return;

        const thead = document.getElementById('print-thead');
        const tbody = document.getElementById('print-tbody');
        document.getElementById('print-subtitle').innerText = `تفاصيل شهادة: ${selectedCert.title_ar || selectedCert.title_en}`;

        thead.innerHTML = `
            <tr>
                <th style="width:30%">العنصر</th>
                <th style="width:70%">التفاصيل</th>
            </tr>
        `;

        const addRow = (label, val) => {
            if(!val) val = '-';
            return `<tr><td style="font-weight:bold; background:#fafafa;">${label}</td><td>${val}</td></tr>`;
        };

        let coursesStr = "";
        for(let i=1; i<=4; i++) {
            if(selectedCert[`course_${i}`]) coursesStr += selectedCert[`course_${i}`] + "، ";
        }
        coursesStr = coursesStr.replace(/، $/, "");

        tbody.innerHTML = `
            ${addRow("اسم الشهادة (عربي)", selectedCert.title_ar)}
            ${addRow("اسم الشهادة (إنجليزي)", selectedCert.title_en)}
            ${addRow("الكلية", selectedCert.college)}
            ${addRow("القسم", selectedCert.department)}
            ${addRow("الجهة المانحة", selectedCert.provider)}
            ${addRow("المستوى", selectedCert.level)}
            ${addRow("التكلفة", selectedCert.cost)}
            ${addRow("اللغة", selectedCert.language)}
            ${addRow("آلية التنفيذ", selectedCert.mode)}
            ${addRow("دعم هدف", selectedCert.is_supported)}
            ${addRow("نبذة", selectedCert.description)}
            ${addRow("الموضوعات", selectedCert.topics)}
            ${addRow("المتطلبات", selectedCert.requirements)}
            ${addRow("مدة الاختبار", selectedCert.exam_duration)}
            ${addRow("عدد الأسئلة", selectedCert.questions_count)}
            ${addRow("نوع الأسئلة", selectedCert.questions_type)}
            ${addRow("الصلاحية", selectedCert.validity)}
            ${addRow("إجراءات التقديم", selectedCert.registration_steps)}
            ${addRow("المصادر", selectedCert.resources)}
            ${addRow("المقررات المرتبطة", coursesStr)}
        `;

        window.print();
    }

    window.onclick = function(e) {
        if(e.target == document.getElementById('certModal')) closeModal();
    }

    loadExcelData();

</script>

</body>
</html>
